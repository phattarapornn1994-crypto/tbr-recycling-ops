<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TBR Recycling OPS | Login</title>

  <!-- ฟอนต์ Kanit -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-main: #e8f3e8;        /* เขียวอ่อนแนวรีไซเคิล */
      --bg-card: #ffffff;
      --text-main: #1a1a1a;
      --accent-green: #2f7d32;   /* เขียวหลัก */

      --radius-lg: 16px;
      --shadow-card: 0 12px 32px rgba(0,0,0,0.06);
      --border-soft: 1px solid rgba(0,0,0,0.07);

      --font-stack: "Kanit", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      font-family: var(--font-stack);
      letter-spacing: 0.02em;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--bg-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
    }

    .login-wrapper {
      background-color: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      border: var(--border-soft);
      width: 360px; /* ถ้าข้อความยาวหล่นค่อยขยับเป็น 380px */
      max-width: 90%;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ส่วนหัวโลโก้ */
    .brand-box {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .brand-logo {
      width: 44px;
      min-width: 44px;
      height: 44px;
      border-radius: 10px;
      background: #d9ead9; /* กล่องเขียวอ่อนรองโลโก้ */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 6px 16px rgba(0,0,0,0.07);
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-green);
    }
    .brand-logo img {
      max-width: 36px;
      max-height: 36px;
      object-fit: contain;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .brand-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-green);
    }

    .brand-subtitle {
      font-size: 14px;
      color: #555;
      line-height: 1.2;
      font-weight: 400;
      white-space: nowrap; /* เราเพิ่มบรรทัดนี้เพื่อกันไม่ให้ขึ้นบรรทัดใหม่ */
    }

    .access-badge {
      background-color: #eef7ee;
      color: var(--accent-green);
      font-size: 12px;
      font-weight: 600;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(47,125,50,0.2);
      width: fit-content;
      line-height: 1.1;
      box-shadow: 0 4px 12px rgba(47,125,50,0.15);
      margin-top: 6px;
    }

    /* ฟอร์มล็อกอิน */
    .form-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    label {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      display: block;
      margin-bottom: 4px;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 10px 12px;
      font-size: 16px;
      background: #fff;
      outline: none;
      font-family: var(--font-stack);
      font-weight: 400;
    }

    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: var(--accent-green);
      box-shadow: 0 0 0 3px rgba(47,125,50,0.18);
    }

    button.login-btn {
      background-color: var(--accent-green);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      padding: 10px 12px;
      line-height: 1.2;
      box-shadow: 0 10px 20px rgba(47,125,50,0.3);
      width: 100%;
      font-family: var(--font-stack);
    }

    button.login-btn:hover {
      filter: brightness(1.05);
      box-shadow: 0 14px 28px rgba(47,125,50,0.4);
    }

    .status-text {
      font-size: 14px;
      min-height: 20px;
      color: #b00020;
      font-weight: 500;
      word-break: break-word;
      white-space: pre-line;
      line-height: 1.3;
      margin-top: 4px;
      text-align: center;
      width: 100%;
      padding: 0 6px;
    }

    .footer-note {
      font-size: 12px;
      color: #777;
      text-align: center;
      line-height: 1.4;
      font-weight: 400;
    }
  </style>
</head>

<body>
  <main class="login-wrapper">
    <!-- ส่วนหัว -->
    <section class="brand-box">
      <div class="brand-logo">
        <!-- ถ้ามีไฟล์โลโก้แล้ว เช่น logo.png ค่อยเปลี่ยนเป็น <img src="logo.png" /> -->
        LOGO
      </div>
      <div class="brand-text">
        <div class="brand-title">TBR Recycling OPS</div>
        <div class="brand-subtitle">เก็บข้อมูลร้านรับซื้อ · วัสดุเข้า · ความถี่การส่ง</div>
        <div class="access-badge" id="roleBadge">
          สิทธิ์เข้าถึง
        </div>
      </div>
    </section>

    <!-- ฟอร์มล็อกอิน -->
    <section class="form-area">
      <div>
        <label for="email">อีเมล</label>
        <input id="email" type="email" placeholder="name@company.com" />
      </div>

      <div>
        <label for="password">รหัสผ่าน</label>
        <input id="password" type="password" placeholder="••••••••" />
      </div>

      <button class="login-btn" id="loginBtn">เข้าสู่ระบบ</button>

      <div class="status-text" id="statusBox"></div>
    </section>

    <!-- ข้อความล่างสุด -->
    <section class="footer-note">
      ระบบนี้สำหรับการใช้งานภายในเท่านั้น<br />
      ห้ามเผยแพร่ข้อมูลลูกค้า/คู่ค้าโดยไม่ได้รับอนุญาต
    </section>
  </main>

  <!-- =========================
       ส่วน Firebase จริง
       ========================= -->
<script type="module">
  import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { 
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { 
    getFirestore,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Firebase config ของคุณ
  const firebaseConfig = {
    apiKey: "AIzaSyCDUGrwNqCOe_lysRbABlp3r6woaL_L1L4",
    authDomain: "tbr-recycling-ops.firebaseapp.com",
    projectId: "tbr-recycling-ops",
    storageBucket: "tbr-recycling-ops.firebasestorage.app",
    messagingSenderId: "527372313469",
    appId: "1:527372313469:web:d7260893ba8deee81fe214"
  };

  // เริ่ม Firebase
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // element ในหน้า
  const emailEl   = document.getElementById('email');
  const passEl    = document.getElementById('password');
  const statusEl  = document.getElementById('statusBox');
  const loginBtn  = document.getElementById('loginBtn');
  const roleBadge = document.getElementById('roleBadge');

  function setStatus(msg, color = "#b00020") {
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.style.color = color;
  }

  // โหลดข้อมูลสิทธิ์/role จาก Firestore แล้ว cache
  async function loadUserProfileAndCache(uid, emailFromAuth = null) {
    let roleText = "(offline)";
    let profileData = null;

    try {
      const profileRef = doc(db, "users", uid);
      const snap = await getDoc(profileRef);

      if (snap.exists()) {
        profileData = snap.data();
      } else {
        // ❗ ถ้าใน Firestore ไม่มีเอกสาร user → ทำ fallback ให้เลย
        profileData = {
          uid: uid,
          email: emailFromAuth || "",
          role: "admin"   // จะเปลี่ยนเป็น "guest" ก็ได้
        };
      }
    } catch (err) {
      console.warn("โหลด Firestore profile ไม่ได้:", err);
      // ถ้าโหลดไม่ได้จริงๆ ก็ยังเก็บแบบ offline
      profileData = {
        uid: uid,
        email: emailFromAuth || "",
        role: "admin"
      };
    }

    // เก็บลง sessionStorage ให้ทุกหน้าใช้
    sessionStorage.setItem("userProfile", JSON.stringify(profileData));
    roleText = profileData.role || "(ไม่ระบุ)";

    if (roleBadge) {
      roleBadge.textContent = `สิทธิ์เข้าถึง: ${roleText}`;
    }

    return profileData;
  }

  // กดปุ่มเข้าสู่ระบบ
  loginBtn.addEventListener('click', async () => {
    const email = emailEl.value.trim();
    const pass  = passEl.value.trim();

    if (!email || !pass) {
      setStatus("กรุณากรอกอีเมลและรหัสผ่าน");
      return;
    }

    setStatus("กำลังล็อกอิน...","#333");

    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      const user = cred.user;

      // ⭐ เก็บ authUser ไว้ด้วย (เผื่อหน้าอื่นต้องการแค่อีเมลกับ uid)
      sessionStorage.setItem("authUser", JSON.stringify({
        uid: user.uid,
        email: user.email
      }));

      // โหลดโปรไฟล์สิทธิ์
      await loadUserProfileAndCache(user.uid, user.email);

      setStatus("ล็อกอินสำเร็จ ✅", "#2f7d32");
      window.location.href = "./dashboard.html";

    } catch (err) {
      console.error(err);
      setStatus("ล็อกอินไม่สำเร็จ: " + err.message, "#b00020");
    }
  });

  // ถ้าล็อกอินค้างอยู่แล้ว → ไป dashboard เลย
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // เก็บ authUser ด้วย
      sessionStorage.setItem("authUser", JSON.stringify({
        uid: user.uid,
        email: user.email
      }));
      // แล้วโหลดสิทธิ์
      await loadUserProfileAndCache(user.uid, user.email);
      window.location.href = "./dashboard.html";
    } else {
      // ไม่ได้ล็อกอิน → เคลียร์สถานะหน้า login ไว้เฉยๆ
      setStatus("");
    }
  });
</script>
</body>

</html>
