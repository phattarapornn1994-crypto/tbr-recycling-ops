<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>TBR Recycling OPS | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --green:#2f7d32;
      --soft:#f5faf5;
      --line:#e5eee5;
      --text:#122;
    }
    *{box-sizing:border-box;font-family:"Kanit",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{margin:0;background:#eef4ef}

    /* ===== ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô dashboard: ‡∏Ñ‡∏£‡∏≠‡∏ö header + tabs ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ===== */
    .topbar-wrap{
      position:sticky;
      top:0;
      z-index:120;
      background:#fff;
      box-shadow:0 4px 16px rgba(0,0,0,.05);
    }
    header.topbar{
      background:#fff;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 18px 6px 18px;
      border-bottom:1px solid rgba(0,0,0,.03);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand-logo{
      width:54px;height:54px;background:#dfecd7 url("./logo.png") center/62% no-repeat;
      border-radius:16px;border:1px solid rgba(0,0,0,.03);
    }
    .brand-text{line-height:1.1}
    .brand-title{font-weight:700;color:#165c1a}
    .brand-sub{font-size:13px;color:#556}
    .userbox{display:flex;align-items:center;gap:16px}
    .logout-btn{
      background:#fff;border:1px solid rgba(0,0,0,.1);
      border-radius:14px;padding:8px 20px;font-weight:600;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.05);
    }

    /* tabs ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô dashboard */
    .tabs{
      display:flex;gap:0;width:100%;
      background:linear-gradient(180deg,#fff 0%,#f4f8f4 100%);
      border-top:1px solid rgba(0,0,0,.03);
    }
    .tab-item{
      padding:12px 22px;
      cursor:pointer;
      font-weight:600;
      color:#1d3d1f;
      border-bottom:3px solid transparent;
      transition:.15s;
    }
    .tab-item.active{
      background:#e8f6ea;
      border-bottom:3px solid #2f7d32;
      color:#2f7d32;
    }

    main{padding:18px;display:flex;gap:18px;align-items:flex-start}
    .left-panel{
      width:340px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 15px 35px rgba(0,0,0,.03);
      border:1px solid rgba(0,0,0,.03);
      padding:16px;
      position:sticky;top:140px;   /* = ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏≤ header+tabs ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
      height:calc(100vh - 150px);
      overflow-y:auto;
    }
    .section-title{font-weight:600;margin-bottom:6px;color:#194f21}
    .input{width:100%;padding:8px 10px;border:1px solid #dfe9e0;border-radius:10px}
    select.input{background:#fff}
    .status-line{font-size:12px;margin-top:8px;color:#b00020;white-space:pre-line}

    .right-panel{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.03);
      box-shadow:0 15px 35px rgba(0,0,0,.03);
      padding:16px 18px;
    }
    .tag{background:#eef7ee;color:#2f7d32;font-size:12px;padding:2px 10px;border-radius:99px;margin-right:4px}
    .rel-pill{
      display:inline-block;background:#2f7d32;color:#fff;border-radius:999px;padding:4px 12px;margin-top:6px
    }
    textarea{width:100%;min-height:90px;padding:8px 10px;border:1px solid #dfe9e0;border-radius:10px}
  </style>
</head>
<body>
  <!-- ===== TOP (sticky) ===== -->
  <div class="topbar-wrap">
    <header class="topbar">
      <div class="brand">
        <div class="brand-logo"></div>
        <div class="brand-text">
          <div class="brand-title">TBR Recycling OPS</div>
          <div class="brand-sub">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        </div>
      </div>
      <div class="userbox">
        <div id="userEmail">-</div>
        <button id="btnLogout" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </header>
    <div class="tabs">
      <div class="tab-item" id="tab-dashboard">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•</div>
      <div class="tab-item" id="tab-map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà & ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
      <div class="tab-item" id="tab-analysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="tab-item active" id="tab-crm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
    </div>
  </div>

  <main>
    <!-- LEFT -->
    <aside class="left-panel">
      <div class="section-title">üì¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
      <input id="shopSearch" class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ä‡πà‡∏ô '‡∏•‡∏≤‡∏ô‡∏≠‡∏ò‡∏¥‡∏°‡∏≤‡∏ï‡∏£' ..." />
      <select id="shopSelect" size="12" class="input" style="margin-top:10px;min-height:360px"></select>
      <div id="statusLine" class="status-line"></div>
      <p style="font-size:11px;color:#999;margin-top:10px">
        * ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Dashboard (‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•) + ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• engagement ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      </p>
    </aside>

    <!-- RIGHT -->
    <section class="right-panel">
      <div class="card">
        <h2 id="shopName" style="margin:0 0 4px 0">-</h2>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span id="shopIdText" class="tag">id: -</span>
          <span id="tagRegion" class="tag">‡∏†‡∏≤‡∏Ñ - / ‡∏•‡∏≤‡∏ô -</span>
          <span id="lastContact" class="tag" style="background:#fff2cc;color:#b57300">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
        </div>
        <p id="shopAddr" style="margin-top:8px;color:#555">-</p>
        <p id="contactInfo" style="color:#555;margin-top:0">-</p>
        <div id="relScorePill" class="rel-pill">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå -</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">üéØ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£?</h3>
        <p style="margin-top:4px">
          ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤ <b>‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° / ‡πÇ‡∏ó‡∏£ / ‡∏™‡πà‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</b> ‡πÉ‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô
        </p>
      </div>

      <div class="card">
        <h3 style="margin-top:0">üß† ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
        <div id="relExplain" style="white-space:pre-line;font-size:13px"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">üìã ‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</h3>
        <textarea id="actionPlan" placeholder="‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô"></textarea>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ---------- firebase ----------
    const firebaseConfig = {
      apiKey:"AIzaSyCn-4Po1XQFNhnFnoIeebKUl3q7BCDLp5w",
      authDomain:"tbr-recycling-ops.firebaseapp.com",
      projectId:"tbr-recycling-ops",
      storageBucket:"tbr-recycling-ops.firebasestorage.app",
      messagingSenderId:"527372313469",
      appId:"1:527372313469:web:d7260893ba8deee81fe214"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---------- dom ----------
    const userEmailEl   = document.getElementById("userEmail");
    const btnLogoutEl   = document.getElementById("btnLogout");
    const shopSearchEl  = document.getElementById("shopSearch");
    const shopSelectEl  = document.getElementById("shopSelect");
    const shopNameEl    = document.getElementById("shopName");
    const shopAddrEl    = document.getElementById("shopAddr");
    const contactInfoEl = document.getElementById("contactInfo");
    const tagRegionEl   = document.getElementById("tagRegion");
    const lastContactEl = document.getElementById("lastContact");
    const relScorePill  = document.getElementById("relScorePill");
    const relExplainEl  = document.getElementById("relExplain");
    const actionPlanEl  = document.getElementById("actionPlan");
    const statusLineEl  = document.getElementById("statusLine");
    const shopIdTextEl  = document.getElementById("shopIdText");

    // tabs ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô dashboard
    document.getElementById("tab-dashboard").onclick = ()=>location.href="./dashboard.html";
    document.getElementById("tab-map").onclick       = ()=>location.href="./map.html";
    document.getElementById("tab-analysis").onclick  = ()=>location.href="./shop-analysis.html";
    document.getElementById("tab-crm").onclick       = ()=>{};

    btnLogoutEl.onclick = async ()=>{
      try{ await signOut(auth); }catch(e){}
      sessionStorage.clear();
      location.href="./login.html";
    };

    // helpers
    function loadSoftDeleted(){
      const raw = localStorage.getItem("tbr_soft_deleted");
      if(!raw) return [];
      try { return JSON.parse(raw) || []; } catch { return []; }
    }
    async function fetchShopsFromFirestore(){
      const snap = await getDocs(collection(db,"shops"));
      const arr = [];
      snap.forEach(docSnap=>{
        arr.push({ id:docSnap.id, ...docSnap.data() });
      });
      sessionStorage.setItem("allShops", JSON.stringify(arr));
      localStorage.setItem("allShops", JSON.stringify(arr));
      return arr;
    }
    function loadDashboardShopsFromCache(){
      const keys = ["allShops","shops","dashboardData","shopsCache","offlineShops","selectedShopsForMap"];
      const out = [];
      keys.forEach(k=>{
        const raw = sessionStorage.getItem(k);
        if(!raw) return;
        try{
          const arr = JSON.parse(raw);
          if(Array.isArray(arr)) out.push(...arr);
        }catch(e){}
      });
      const lks = ["offlineShops","allShops","shopsCache"];
      lks.forEach(k=>{
        const raw = localStorage.getItem(k);
        if(!raw) return;
        try{
          const arr = JSON.parse(raw);
          if(Array.isArray(arr)) out.push(...arr);
        }catch(e){}
      });
      const cur = sessionStorage.getItem("viewShop") || sessionStorage.getItem("currentShop");
      if(cur){
        try{ out.push(JSON.parse(cur)); }catch(e){}
      }
      const uniq = [];
      const seen = new Set();
      for(const s of out){
        const key = (s.id||"")+"||"+(s.shopName||"").toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        uniq.push(s);
      }
      return uniq;
    }
    function loadEngagementRows(){
      const raw = sessionStorage.getItem("customer-engagement");
      if(!raw) return [];
      try{
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function daysFrom(str){
      if(!str) return null;
      const d = new Date(str);
      if(isNaN(d)) return null;
      return Math.floor((Date.now()-d.getTime())/(1000*60*60*24));
    }
    function gradeFromScore(sc){
      if(sc>=90) return "A";
      if(sc>=75) return "B";
      if(sc>=55) return "C";
      return "D";
    }
    function analyzeRelation(item){
      const eng  = item._rawEng;
      const dash = item._rawDash;
      let score = 100;
      const explain = [];
      let days = null;

      if(eng?.lastContactDate){
        days = daysFrom(eng.lastContactDate);
      }else if(eng?.lastContactDays){
        days = eng.lastContactDays;
      }
      if(days!=null){
        if(days<=7){ explain.push("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô ‚úÖ"); }
        else if(days<=30){ score -= 10; explain.push("‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô"); }
        else if(days<=60){ score -= 20; explain.push("‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"); }
        else { score -= 35; explain.push("‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"); }
      }else{
        score -= 25;
        explain.push("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠");
      }

      const loyalty = eng?.loyaltyProgram === true || eng?.loyaltyProgram === "true";
      if(!loyalty){
        score -= 10;
        explain.push("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° Loyalty");
      }

      if(!eng?.preferredChannel && !dash?.communication?.preferredChannels){
        score -= 5;
        explain.push("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö");
      }

      if(score<0) score=0;
      return { score, explain: explain.join("\n"), days };
    }
    function renderDetail(item, rel){
      const dash = item._rawDash;
      const eng  = item._rawEng;

      shopNameEl.textContent  = item.shopName || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)";
      shopIdTextEl.textContent= dash?.id ? `id: ${dash.id}` : "(offline / from sheet)";
      tagRegionEl.textContent = (dash?.regionId||"-")+" / "+(dash?.yardId||"-");
      shopAddrEl.textContent  = dash?.location?.address || eng?.address || "-";

      contactInfoEl.textContent = dash?.contactInfo?.phone
        ? `‡πÇ‡∏ó‡∏£ ${dash.contactInfo.phone}${dash.contactInfo.line ? " | LINE "+dash.contactInfo.line : ""}`
        : (eng?.contact || "-");

      if(rel.days!=null){
        lastContactEl.textContent = `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${rel.days} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
      }else{
        lastContactEl.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠";
      }

      relScorePill.textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ${rel.score} (${gradeFromScore(rel.score)})`;
      relExplainEl.textContent = rel.explain;

      if(dash){
        sessionStorage.setItem("currentShop", JSON.stringify(dash));
      }else if(eng){
        sessionStorage.setItem("currentShop", JSON.stringify(eng));
      }
    }

    // ---------- main ----------
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="./login.html"; return; }
      userEmailEl.textContent = user.email || "-";
      statusLineEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô...";

      const softDeleted = loadSoftDeleted();
      let master = [];

      // 1) ‡∏à‡∏≤‡∏Å Firestore
      try{
        const fresh = await fetchShopsFromFirestore();
        master = fresh.map(s=>({
          source:"firestore",
          shopName:s.shopName || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)",
          _rawDash:s,
          _rawEng:null
        }));
      }catch(e){
        master = [];
      }

      // 2) ‡∏à‡∏≤‡∏Å cache
      const cached = loadDashboardShopsFromCache();
      cached.forEach(s=>{
        const key = (s.id||"")+"||"+(s.shopName||"").toLowerCase();
        const exists = master.find(m => (m._rawDash?.id||"")+"||"+(m.shopName||"").toLowerCase() === key);
        if(!exists){
          master.push({
            source:"cache",
            shopName:s.shopName || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)",
            _rawDash:s,
            _rawEng:null
          });
        }
      });

      // 3) ‡∏à‡∏≤‡∏Å engagement ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
      const engs = loadEngagementRows();
      engs.forEach(row=>{
        const name = (row.shopName||"").trim();
        if(!name){
          master.push({source:"eng",shopName:"(‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)",_rawDash:null,_rawEng:row});
          return;
        }
        const existed = master.find(m => m.shopName && m.shopName.toLowerCase()===name.toLowerCase());
        if(existed){
          existed._rawEng = row;
        }else{
          master.push({source:"eng",shopName:name,_rawDash:null,_rawEng:row});
        }
      });

      // 4) ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
      if(softDeleted.length){
        master = master.filter(m => m._rawDash?.id ? !softDeleted.includes(m._rawDash.id) : true);
      }

      if(!master.length){
        statusLineEl.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô";
        return;
      }

      // ‡πÄ‡∏ï‡∏¥‡∏° select
      shopSelectEl.innerHTML = "";
      master.forEach((item,idx)=>{
        const opt = document.createElement("option");
        opt.value = item.shopName || ("shop_"+idx);
        opt.textContent = (item.source==="eng" ? "üìÑ " : "üìã ") + (item.shopName || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)");
        opt.dataset.index = idx;
        shopSelectEl.appendChild(opt);
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏Å
      const first = master[0];
      const rel0  = analyzeRelation(first);
      renderDetail(first, rel0);
      statusLineEl.textContent = `‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ${master.length} ‡∏£‡πâ‡∏≤‡∏ô`;

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      shopSearchEl.addEventListener("input", ()=>{
        const q = shopSearchEl.value.toLowerCase().trim();
        for(const opt of shopSelectEl.options){
          const txt = opt.textContent.toLowerCase();
          opt.style.display = txt.includes(q) ? "block" : "none";
        }
      });

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡πâ‡∏≤‡∏ô
      shopSelectEl.addEventListener("change", ()=>{
        const idx = shopSelectEl.selectedOptions[0]?.dataset.index;
        if(idx==null) return;
        const item = master[+idx];
        const rel  = analyzeRelation(item);
        renderDetail(item, rel);
      });
    });
  </script>
</body>
</html>
