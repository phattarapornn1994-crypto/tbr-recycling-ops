<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>TBR Recycling OPS | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg-main:#e8f3e8;
      --bg-card:#fff;
      --text:#132;
      --green:#2f7d32;
      --deep:#165c1a;
      --line:#e5eee5;
      --soft:#f6fbf6;
      --bd:1px solid rgba(0,0,0,.06);
      --shadow-sm:0 8px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box;font-family:"Kanit",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{margin:0;background:var(--bg-main);color:var(--text)}

    /* ===== TOPBAR (‡∏¢‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å dashboard ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô) ===== */
    .topbar-wrap{
      position:sticky; top:0; z-index:999;
      background:#fff; box-shadow:0 4px 16px rgba(0,0,0,.05);
    }
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:14px 20px 10px;
    }
    .topbar-left{display:flex; gap:12px; align-items:center}
    .logo-box{
      width:52px;height:52px;border-radius:14px;background:#d9ead9;border:1px solid rgba(0,0,0,.03);
      display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:var(--shadow-sm);
    }
    .logo-box img{width:100%;height:100%;object-fit:contain}
    .app-title{display:flex;flex-direction:column;gap:2px}
    .app-name{font-size:18px;font-weight:600;color:var(--green)}
    .app-sub{font-size:13px;color:#555}
    .topbar-right{display:flex;gap:10px;align-items:center}
    .user-mail{font-size:13px;color:#444}
    .btn-logout{
      background:#fff;border:1px solid rgba(0,0,0,.14);border-radius:10px;padding:6px 14px;font-weight:600;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
    }
    .tabs{
      display:flex;background:linear-gradient(180deg,#fff 0%,#f4f8f4 100%);
      border-top:1px solid rgba(0,0,0,.03);
    }
    .tab{
      padding:10px 22px; cursor:pointer; font-weight:600; color:#2d3b2f; border-bottom:3px solid transparent;
    }
    .tab:hover{background:rgba(232,243,232,.35);}
    .tab.active{color:var(--green); border-bottom:3px solid var(--green); background:#e8f6ea;}

    /* ===== LAYOUT ===== */
    main{padding:16px 20px 20px; display:flex; gap:16px}
    aside{
      width:330px;background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.03);
      box-shadow:0 15px 35px rgba(0,0,0,.03); padding:14px;
      position:sticky; top:140px; height:calc(100vh - 160px); overflow-y:auto;   /* top 140 ‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô header+tabs */
    }
    .input{width:100%;padding:9px 11px;border:1px solid #dfe9e0;border-radius:10px}
    .mini{font-size:12px;color:#667}
    .hr{height:1px;background:#eef2ef;margin:8px 0}

    section.content{flex:1;display:flex;flex-direction:column;gap:16px}
    .card{background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.03);box-shadow:0 15px 35px rgba(0,0,0,.03);padding:14px 16px}
    .card h3{margin:0 0 8px 0;color:var(--deep)}
    .pill{display:inline-block;background:#eef7ee;color:var(--green);border:1px solid rgba(47,125,50,.2);padding:3px 10px;border-radius:999px;font-size:12px;margin-right:6px}
    .tag-amber{background:#fff6e5;color:#b36a00;border-color:#ffe1b4}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .kpi{background:var(--soft);border:1px solid var(--line);padding:12px;border-radius:12px;display:flex;flex-direction:column;gap:2px}
    .kpi .v{font-size:20px;font-weight:700;color:var(--deep)}
    .status{font-size:12px;color:#b00020;white-space:pre-line}

    canvas{max-width:100%}
  </style>
</head>
<body>

  <!-- ===== TOPBAR & TABS (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô dashboard) ===== -->
  <div class="topbar-wrap">
    <div class="topbar">
      <div class="topbar-left">
        <div class="logo-box"><img src="logo.png" alt="TBR Logo"/></div>
        <div class="app-title">
          <div class="app-name">TBR Recycling OPS</div>
          <div class="app-sub">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="user-mail" id="userEmail">-</div>
        <button class="btn-logout" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tab" id="tab-dashboard">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•</div>
      <div class="tab" id="tab-map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà &amp; ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
      <div class="tab active" id="tab-analysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="tab" id="tab-crm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
    </div>
  </div>

  <main>
    <!-- LEFT -->
    <aside>
      <div style="font-weight:600;margin-bottom:6px">üì¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
      <input id="shopSearch" class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." />
      <select id="shopSelect" size="12" class="input" style="margin-top:8px;min-height:350px"></select>
      <div class="status" id="statusLine"></div>
      <div class="hr"></div>
      <div class="mini">* ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Dashboard / offlineShops / currentShop</div>
    </aside>

    <!-- RIGHT -->
    <section class="content">
      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ô -->
      <div class="card">
        <h3 id="titleShop">-</h3>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span id="pillRegion" class="pill">‡∏†‡∏≤‡∏Ñ - / ‡∏•‡∏≤‡∏ô -</span>
          <span id="pillAddr" class="pill">-</span>
          <span id="pillDist" class="pill tag-amber">‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏ô - ‡∏Å‡∏°.</span>
          <span id="pillGrade" class="pill">‡πÄ‡∏Å‡∏£‡∏î -</span>
        </div>
        <div class="grid-3" style="margin-top:10px">
          <div class="kpi"><div class="t">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div><div id="kpiScore" class="v">-</div><div class="mini">0‚Äì100</div></div>
          <div class="kpi"><div class="t">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏ô</div><div id="kpiDist" class="v">- ‡∏Å‡∏°.</div><div class="mini">Haversine</div></div>
          <div class="kpi"><div class="t">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div><div id="kpiRisk" class="v">-</div><div class="mini">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å</div></div>
        </div>
      </div>

      <!-- 1 ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ -->
      <div class="card">
        <h3>1) ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
        <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ &amp; ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å 4 ‡∏°‡∏¥‡∏ï‡∏¥: <b>‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</b>, <b>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á/‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå</b>, <b>Pricing &amp; Loyalty</b>, <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</b></p>
      </div>

      <!-- 2 ‡πÄ‡∏Å‡∏ì‡∏ë‡πå -->
      <div class="card">
        <h3>2) ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h3>
        <div class="grid-2">
          <div class="kpi">
            <div class="t" style="font-weight:700;color:#165c1a">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>
            <div class="hr" style="margin:6px 0"></div>
            <div>‚Ä¢ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á &gt; 250 ‡∏Å‡∏°. ‚Üí -30</div>
            <div>‚Ä¢ 150‚Äì250 ‡∏Å‡∏°. ‚Üí -20</div>
            <div>‚Ä¢ 80‚Äì150 ‡∏Å‡∏°. ‚Üí -10</div>
            <div>‚Ä¢ Loyalty / Promo ‚Üí +5</div>
            <div>‚Ä¢ ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° (medium‚Äìhigh) ‚Üí +6 ‡∏ñ‡∏∂‡∏á +10</div>
          </div>
          <div class="kpi">
            <div class="t" style="font-weight:700;color:#165c1a">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î</div>
            <div class="hr" style="margin:6px 0"></div>
            <div>A ‚â• 85 ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Ç‡πâ‡∏≤</div>
            <div>B ‚â• 70 ‚Üí ‡∏î‡∏π‡πÅ‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
            <div>C ‚â• 50 ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞</div>
            <div>D &lt; 50 ‚Üí ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
          </div>
        </div>
      </div>

      <!-- 3 ‡∏Å‡∏£‡∏≤‡∏ü -->
      <div class="card">
        <h3>3) ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h3>
        <div class="grid-2">
          <div>
            <div class="t" style="font-weight:700;color:#165c1a;margin-bottom:6px">Radar: ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 5 ‡∏°‡∏¥‡∏ï‡∏¥</div>
            <canvas id="scoreChart" height="170"></canvas>
          </div>
          <div>
            <div class="t" style="font-weight:700;color:#165c1a;margin-bottom:6px">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö</div>
            <div id="channelList" class="channel-list"></div>
          </div>
        </div>
        <div class="grid-2" style="margin-top:12px">
          <div>
            <div class="t" style="font-weight:700;color:#165c1a;margin-bottom:6px">Pareto: ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î</div>
            <canvas id="paretoChart" height="160"></canvas>
          </div>
          <div>
            <div class="t" style="font-weight:700;color:#165c1a;margin-bottom:6px">Risk Meter</div>
            <div id="riskBox" style="background:#fef5f5;border:1px solid rgba(176,0,32,.15);border-radius:12px;padding:10px">
              <div id="riskLabel" style="font-weight:700;color:#165c1a">-</div>
              <div style="width:100%;height:14px;border-radius:999px;background:linear-gradient(90deg,#4caf50,#ffeb3b,#f44336);overflow:hidden;margin-top:6px">
                <div id="riskBar" style="height:100%;background:rgba(255,255,255,.0);width:0%"></div>
              </div>
              <div id="riskExplain" style="font-size:13px;margin-top:6px">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4 ‡πÅ‡∏õ‡∏•‡∏ú‡∏• -->
      <div class="card">
        <h3>4) ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ú‡∏• &amp; ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
        <div id="analysisText" style="white-space:pre-line"></div>
        <div class="hr"></div>
        <div class="grid-3">
          <div class="kpi"><div class="t" style="font-weight:700;color:#165c1a">Action 7 ‡∏ß‡∏±‡∏ô</div><div id="act7" class="mini">-</div></div>
          <div class="kpi"><div class="t" style="font-weight:700;color:#165c1a">Action 30 ‡∏ß‡∏±‡∏ô</div><div id="act30" class="mini">-</div></div>
          <div class="kpi"><div class="t" style="font-weight:700;color:#165c1a">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤</div><div id="actPrice" class="mini">-</div></div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // ===== 1) Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyCDUGrwNqCOe_lysRbABlp3r6woaL_L1L4",
    authDomain:"tbr-recycling-ops.firebaseapp.com",
    projectId:"tbr-recycling-ops",
    storageBucket:"tbr-recycling-ops.firebasestorage.app",
    messagingSenderId:"527372313469",
    appId:"1:527372313469:web:d7260893ba8deee81fe214"
  };
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ===== 2) DOM =====
  const userEmailEl   = document.getElementById("userEmail");
  const btnLogoutEl   = document.getElementById("btnLogout");
  const shopSearchEl  = document.getElementById("shopSearch");
  const shopSelectEl  = document.getElementById("shopSelect");
  const statusLineEl  = document.getElementById("statusLine");

  const titleShopEl   = document.getElementById("titleShop");
  const pillRegionEl  = document.getElementById("pillRegion");
  const pillAddrEl    = document.getElementById("pillAddr");
  const pillDistEl    = document.getElementById("pillDist");
  const pillGradeEl   = document.getElementById("pillGrade");
  const kpiScoreEl    = document.getElementById("kpiScore");
  const kpiDistEl     = document.getElementById("kpiDist");
  const kpiRiskEl     = document.getElementById("kpiRisk");
  const channelListEl = document.getElementById("channelList");
  const riskLabelEl   = document.getElementById("riskLabel");
  const riskBarEl     = document.getElementById("riskBar");
  const riskExplainEl = document.getElementById("riskExplain");
  const analysisTextEl= document.getElementById("analysisText");
  const act7El        = document.getElementById("act7");
  const act30El       = document.getElementById("act30");
  const actPriceEl    = document.getElementById("actPrice");

  // ===== 3) tabs =====
  document.getElementById("tab-dashboard").onclick = ()=>location.href="./dashboard.html";
  document.getElementById("tab-map").onclick       = ()=>location.href="./map.html";
  document.getElementById("tab-analysis").onclick  = ()=>{};
  document.getElementById("tab-crm").onclick       = ()=>location.href="./customer-relations.html";

  btnLogoutEl.onclick = async ()=>{
    try{ await signOut(auth); }catch(e){}
    sessionStorage.clear();
    location.href="./login.html";
  };

  // ===== 4) helper ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ =====
  function deg2rad(x){ return x*Math.PI/180; }
  function haversineKm(aLat,aLng,bLat,bLng){
    if([aLat,aLng,bLat,bLng].some(v=>typeof v!=="number")) return null;
    const R=6371, dLat=deg2rad(bLat-aLat), dLng=deg2rad(bLng-aLng);
    const A=Math.sin(dLat/2)**2 + Math.cos(deg2rad(aLat))*Math.cos(deg2rad(bLat))*Math.sin(dLng/2)**2;
    return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
  }
  function grade(x){ if(x>=85) return "A"; if(x>=70) return "B"; if(x>=50) return "C"; return "D"; }

  function getUserYardFromSession(){
    const raw = sessionStorage.getItem("userProfile");
    if(!raw) return null;
    try{
      const u = JSON.parse(raw);
      if(typeof u.yardLat==="number" && typeof u.yardLng==="number"){
        return { lat:u.yardLat, lng:u.yardLng, regionId:u.regionId, yardId:u.yardId };
      }
    }catch(e){}
    return null;
  }

  function analyzeShop(shop, yard){
    const distKm = (yard && shop?.location?.gps_lat!=null)
      ? haversineKm(yard.lat,yard.lng, shop.location.gps_lat, shop.location.gps_lng)
      : null;

    let distPenalty = 0;
    if(distKm!=null){
      if(distKm>250) distPenalty=30;
      else if(distKm>150) distPenalty=20;
      else if(distKm>80)  distPenalty=10;
    }

    const hasChan = Array.isArray(shop?.communication?.preferredChannels) && shop.communication.preferredChannels.length;
    const wantUpd = !!shop?.communication?.wantUpdates;

    let score = 100 - distPenalty;
    if(!hasChan) score -= 6;
    if(!wantUpd) score -= 4;
    if(score<0) score=0;

    const penalties = [
      {name:"‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á", value:distPenalty},
      {name:"‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î", value: hasChan?0:6},
      {name:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ opt-in ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£", value: wantUpd?0:4}
    ];
    const risk = Math.min(100, distPenalty*2 + (hasChan?0:12) + (wantUpd?0:8));
    const riskLevel = risk>=70 ? "‡∏™‡∏π‡∏á" : risk>=40 ? "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á" : "‡∏ï‡πà‡∏≥";

    return {
      score,
      grade: grade(score),
      distKm: distKm!=null ? distKm.toFixed(1) : "-",
      penalties,
      risk,
      riskLevel,
      hasChan,
      wantUpd
    };
  }

  let radarChart=null, paretoChart=null;
  function drawRadar(res){
    const ctx = document.getElementById("scoreChart");
    if(radarChart) radarChart.destroy();
    radarChart = new Chart(ctx,{
      type:"radar",
      data:{
        labels:["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°","‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤)","‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á","‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£","‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏†‡∏≤‡∏û"],
        datasets:[{
          label:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
          data:[
            res.score,
            100-(res.penalties.find(p=>p.name==="‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á")?.value||0),
            res.hasChan?90:40,
            res.wantUpd?75:40,
            60
          ]
        }]
      },
      options:{plugins:{legend:{display:false}},scales:{r:{min:0,max:100}}}
    });
  }
  function drawPareto(penalties){
    const ctx = document.getElementById("paretoChart");
    if(paretoChart) paretoChart.destroy();
    const sorted = penalties.slice().sort((a,b)=>b.value-a.value);
    paretoChart = new Chart(ctx,{
      type:"bar",
      data:{labels:sorted.map(p=>p.name),datasets:[{label:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢",data:sorted.map(p=>p.value)}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }
  function renderChannels(shop){
    const wrap = document.getElementById("channelList");
    wrap.innerHTML = "";
    const list = Array.isArray(shop?.communication?.preferredChannels) && shop.communication.preferredChannels.length
      ? shop.communication.preferredChannels
      : ["‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á"];
    list.forEach((ch,idx)=>{
      const div = document.createElement("div");
      div.style.cssText = "background:#f8fbf8;border:1px solid rgba(0,0,0,.03);border-radius:10px;padding:6px 10px;display:flex;gap:10px;align-items:center;margin-bottom:8px";
      div.innerHTML = `
        <div style="width:30px;height:30px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center">üì®</div>
        <div style="flex:1">
          <div style="font-weight:600;font-size:13px">${ch}</div>
          <div style="width:100%;height:6px;background:#e9f3e9;border-radius:999px;overflow:hidden;margin-top:3px">
            <div style="height:100%;background:linear-gradient(90deg,#2f7d32,#7ecb7f);width:${100-idx*10}%"></div>
          </div>
        </div>
      `;
      wrap.appendChild(div);
    });
  }
  function renderRiskBox(res){
    riskLabelEl.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${res.riskLevel} (${res.risk.toFixed(0)})`;
    riskBarEl.style.width   = res.risk + "%";
    riskExplainEl.textContent =
      res.riskLevel==="‡∏™‡∏π‡∏á" ? "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• + ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô"
      : res.riskLevel==="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á" ? "‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô"
      : "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö";
  }
  function renderExplain(shop,res){
    const lines = [];
    lines.push(`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° ${res.score.toFixed(0)} (${res.grade})`);
    lines.push(`‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏ô: ${res.distKm} ‡∏Å‡∏°.`);
    if(res.penalties.some(p=>p.value>0)){
      lines.push("‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î:");
      res.penalties.filter(p=>p.value>0).forEach((p,i)=> lines.push(` ${i+1}. ${p.name} (-${p.value})`));
    }else{
      lines.push("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏•‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‚úÖ");
    }
    analysisTextEl.textContent = lines.join("\n");
  }
  function renderActions(res){
    if(res.riskLevel==="‡∏™‡∏π‡∏á"){
      act7El.textContent  = "‡πÇ‡∏ó‡∏£/‡πÑ‡∏•‡∏ô‡πå‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏õ‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥";
      act30El.textContent = "‡∏ô‡∏±‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö";
    }else if(res.riskLevel==="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"){
      act7El.textContent  = "‡∏ó‡∏±‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö";
      act30El.textContent = "‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö loyalty";
    }else{
      act7El.textContent  = "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥";
      act30El.textContent = "‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡∏∑‡πâ‡∏≠";
    }
    actPriceEl.textContent = res.distKm!=="-" && Number(res.distKm)>150
      ? "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á / ‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏£‡πà‡∏ß‡∏°"
      : "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏ã‡∏ô + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠";
  }
  function renderShop(shop,yard){
    const res = analyzeShop(shop,yard);
    titleShopEl.textContent  = shop.shopName || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)";
    pillRegionEl.textContent = (shop.regionId||"-")+" / "+(shop.yardId||"-");
    pillAddrEl.textContent   = shop.location?.address || "-";
    pillDistEl.textContent   = "‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏ô " + (res.distKm || "-") + " ‡∏Å‡∏°.";
    pillGradeEl.textContent  = "‡πÄ‡∏Å‡∏£‡∏î " + res.grade;
    kpiScoreEl.textContent   = res.score.toFixed(0);
    kpiDistEl.textContent    = (res.distKm || "-") + " ‡∏Å‡∏°.";
    kpiRiskEl.textContent    = res.riskLevel + ` (${res.risk.toFixed(0)})`;
    drawRadar(res);
    drawPareto(res.penalties);
    renderChannels(shop);
    renderRiskBox(res);
    renderExplain(shop,res);
    renderActions(res);
  }
  function populateShops(list, selectedId){
    shopSelectEl.innerHTML = "";
    list.forEach((s,idx)=>{
      const opt = document.createElement("option");
      opt.value = s.id || `local_${idx}`;
      opt.textContent = s.shopName || s.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)";
      opt.dataset.index = idx;
      if(selectedId && s.id===selectedId) opt.selected = true;
      shopSelectEl.appendChild(opt);
    });
  }

  // ===== 5) MAIN =====
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      location.href="./login.html";
      return;
    }
    userEmailEl.textContent = user.email || "-";
    statusLineEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore...";

    try {
      // ‡∏î‡∏∂‡∏á "‡πÄ‡∏â‡∏û‡∏≤‡∏∞" ‡∏à‡∏≤‡∏Å Firestore ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      const snap = await getDocs(collection(db,"shops"));
      const shops = [];
      snap.forEach(docSnap=>{
        shops.push({ id: docSnap.id, ...docSnap.data() });
      });

      // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå 2 ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô Firestore ‡∏°‡∏µ 2
      statusLineEl.textContent = `‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ${shops.length} ‡∏£‡πâ‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å Firestore)`;

      if(!shops.length){
        return; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πá‡∏à‡∏ö
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡πâ‡∏≤‡∏ô
      populateShops(shops, shops[0]?.id);
      const yard = getUserYardFromSession();
      renderShop(shops[0], yard);

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      shopSearchEl.addEventListener("input", ()=>{
        const q = shopSearchEl.value.toLowerCase().trim();
        for (const opt of shopSelectEl.options){
          const txt = opt.textContent.toLowerCase();
          opt.style.display = txt.includes(q) ? "block" : "none";
        }
      });

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡πâ‡∏≤‡∏ô
      shopSelectEl.addEventListener("change", ()=>{
        const idx = shopSelectEl.selectedOptions[0]?.dataset.index;
        if(idx==null) return;
        const yard2 = getUserYardFromSession();
        const shop = shops[+idx];
        renderShop(shop, yard2);
      });

    } catch (err) {
      console.log(err);
      statusLineEl.textContent = "‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
    }
  });
</script> 
</body>
</html>

