<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TBR Recycling OPS | Dashboard</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-main:#e8f3e8;
      --bg-card:#fff;
      --bg-soft:#f5faf5;
      --text:#1a1a1a;
      --dim:#666;
      --green:#2f7d32;
      --soft:#e8f6ea;
      --bd:1px solid rgba(0,0,0,.06);
      --shadow:0 16px 40px rgba(0,0,0,.05);
      --shadow-sm:0 8px 24px rgba(0,0,0,.06);
      --radius-lg:20px;
      --radius-md:14px;
      --highlight:#fff9c4;
    }
    *{box-sizing:border-box;font-family:"Kanit",system-ui,sans-serif}
    body{
      margin:0;
      background:var(--bg-main);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ===== TOPBAR STICKY ===== */
    .topbar-wrap{
      position:sticky;
      top:0;
      z-index:999;
      background:#fff;
      box-shadow:0 4px 16px rgba(0,0,0,.05);
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
      padding:14px 20px 10px;
    }
    .topbar-left{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo-box{
      width:52px;
      height:52px;
      border-radius:14px;
      background:#d9ead9;
      border:1px solid rgba(0,0,0,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:var(--shadow-sm);
    }
    .logo-box img{width:100%;height:100%;object-fit:contain}
    .app-title{display:flex;flex-direction:column;gap:2px}
    .app-name{font-size:18px;font-weight:600;color:var(--green)}
    .app-sub{font-size:13px;color:#555}
    .topbar-right{display:flex;gap:10px;align-items:center}
    .user-mail{font-size:13px;color:#444}
    .btn-logout{
      background:#fff;
      border:1px solid rgba(0,0,0,.14);
      border-radius:10px;
      padding:6px 14px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
    }
    .tabs{
      display:flex;
      background:linear-gradient(180deg,#fff 0%,#f4f8f4 100%);
      border-top:1px solid rgba(0,0,0,.03);
    }
    .tab{
      padding:10px 22px;
      cursor:pointer;
      font-weight:600;
      color:#2d3b2f;
      border-bottom:3px solid transparent;
    }
    .tab:hover{background:rgba(232,243,232,.35);}
    .tab.active{
      color:var(--green);
      border-bottom:3px solid var(--green);
      background:#e8f6ea;
    }

    /* ===== MAIN LAYOUT ===== */
    main{
      flex:1;
      display:flex;
      gap:18px;
      padding:16px 20px 20px;
      min-height:0;
    }
    aside{
      width:320px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      background:#fff;
      border:var(--bd);
      border-radius:16px;
      padding:14px 14px 12px;
      box-shadow:var(--shadow-sm);
    }
    .card-title{
      font-weight:600;
      color:var(--green);
      display:flex;
      gap:6px;
      align-items:center;
      margin-bottom:6px;
    }
    .card-sub{
      font-size:13px;
      color:#666;
      margin-bottom:10px;
    }
    label{font-size:13px;font-weight:600;margin-bottom:4px;display:block}
    input,select{
      width:100%;
      padding:7px 10px;
      border:1px solid rgba(0,0,0,.15);
      border-radius:10px;
      margin-bottom:8px;
      background:#fff;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--green);
      box-shadow:0 0 0 3px rgba(47,125,50,.12);
    }
    .small-hint{font-size:12px;color:#888}

    .btn-primary{
      background:var(--green);
      color:#fff;
      border:none;
      border-radius:10px;
      padding:8px 12px;
      font-weight:600;
      cursor:pointer;
      width:100%;
      box-shadow:0 10px 24px rgba(47,125,50,.35);
    }
    .btn-secondary{
      background:#fff;
      color:#2f7d32;
      border:1px solid rgba(47,125,50,.28);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
      font-weight:600;
    }

    /* ===== RIGHT (TABLE) ===== */
    .content{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .content-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .content-title{
      font-weight:600;
      font-size:16px;
      color:#243526;
    }
    .content-sub{font-size:13px;color:#666}
    .table-wrap{
      background:#fff;
      border:var(--bd);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:280px;
    }
    .table-header{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-bottom:var(--bd);
      background:#f6faf6;
    }
    .table-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .table-search{
      margin-left:auto;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .table-search input{
      width:180px;
      margin:0;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid rgba(0,0,0,.04);
      white-space:nowrap;
      background:#fff;
    }
    tbody td{
      padding:8px 10px;
      border-bottom:1px solid rgba(0,0,0,.025);
      vertical-align:top;
    }
    tbody tr:nth-child(even){
      background:#fafdf9;
    }
    .tag{
      background:#e8f6ea;
      color:#2f7d32;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      display:inline-block;
      margin-right:3px;
    }
    .row-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .btn-sm{
      border:none;
      border-radius:6px;
      padding:3px 8px 4px;
      font-size:12px;
      cursor:pointer;
      font-weight:500;
    }
    .btn-view{background:#edf4ff;color:#1640a0}
    .btn-edit{background:#fff3d9;color:#a16400}
    .btn-del{background:#ffe7e7;color:#c62828}

    .scroll-body{
      overflow:auto;
      max-height:calc(100vh - 210px);
    }

    .status-line{
      min-height:20px;
      font-size:12px;
      font-weight:600;
      color:#b00020;
      white-space:pre-line;
      margin-top:4px;
    }

    .row-highlight{animation:flash 2s ease-out;}
    @keyframes flash{
      0%{background:var(--highlight);}
      100%{background:transparent;}
    }

    @media(max-width:1080px){
      main{flex-direction:column}
      aside{width:100%;flex-direction:row;overflow:auto}
      .table-header{flex-wrap:wrap}
      .scroll-body{max-height:unset}
      .table-search{margin-left:0}
    }
  </style>
</head>
<body>
  <!-- ===== TOPBAR ===== -->
  <div class="topbar-wrap">
    <div class="topbar">
      <div class="topbar-left">
        <div class="logo-box"><img src="logo.png" alt="TBR Logo"></div>
        <div class="app-title">
          <div class="app-name">TBR Recycling OPS</div>
          <div class="app-sub" id="scopeText">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="user-mail" id="userEmail">-</div>
        <button class="btn-logout" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" id="tab-dashboard">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•</div>
      <div class="tab" id="tab-map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà &amp; ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
      <div class="tab" id="tab-analysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="tab" id="tab-crm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
    </div>
  </div>

  <main>
    <!-- ===== LEFT ===== -->
    <aside>
      <div class="card">
        <div class="card-title">üéØ ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
        <div class="card-sub">‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏†‡∏≤‡∏Ñ/‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        <label for="regionFilter">‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
        <select id="regionFilter"></select>
        <label for="yardFilter">‡∏•‡∏≤‡∏ô/‡∏™‡∏≤‡∏Ç‡∏≤</label>
        <select id="yardFilter"></select>
        <div class="small-hint" id="roleInfo">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: -</div>
      </div>

      <div class="card">
        <div class="card-title">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
        <div class="card-sub">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≥</div>
        <input id="searchBeforeAdd" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏¢‡∏ä‡∏°‡∏û‡∏π ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•"/>
        <button class="btn-primary" id="btnCheckShop">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <div class="status-line" id="checkResult"></div>
        <div style="margin-top:6px">
          <button class="btn-secondary" id="btnAddNew">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìç ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏î‡∏π‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
        <div class="card-sub">‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</div>
        <button class="btn-primary" id="btnGoMap">‡∏î‡∏π‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
        <div class="small-hint">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
      </div>
    </aside>

    <!-- ===== RIGHT ===== -->
    <div class="content">
      <div class="content-top">
        <div>
          <div class="content-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•</div>
          <div class="content-sub" id="listDesc">‚Äî</div>
        </div>
      </div>

      <div class="table-wrap">
        <div class="table-header">
          <div class="table-actions">
            <button class="btn-secondary" id="btnSelectAll">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn-secondary" id="btnClearAll">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
          </div>
          <div class="table-search">
            <input id="tableSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á..." />
          </div>
          <div class="status-line" id="statusLine"></div>
        </div>
        <div class="scroll-body">
          <table>
            <thead>
              <tr>
                <th style="width:34px"></th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</th>
                <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                <th>‡∏†‡∏≤‡∏Ñ / ‡∏•‡∏≤‡∏ô</th>
                <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
                <th style="width:160px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
              </tr>
            </thead>
            <tbody id="shopsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase + dashboard logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    /* ===== FIREBASE CONFIG ===== */
    const firebaseConfig = {
      apiKey:"AIzaSyCn-4Po1XQFNhnFnoIeebKUl3q7BCDLp5w",
      authDomain:"tbr-recycling-ops.firebaseapp.com",
      projectId:"tbr-recycling-ops",
      storageBucket:"tbr-recycling-ops.firebasestorage.app",
      messagingSenderId:"527372313469",
      appId:"1:527372313469:web:d7260893ba8deee81fe214"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ===== DOM ===== */
    const userEmailEl  = document.getElementById("userEmail");
    const btnLogoutEl  = document.getElementById("btnLogout");
    const shopsBodyEl  = document.getElementById("shopsBody");
    const statusLineEl = document.getElementById("statusLine");
    const checkResultEl= document.getElementById("checkResult");
    const regionFilterEl = document.getElementById("regionFilter");
    const yardFilterEl   = document.getElementById("yardFilter");
    const roleInfoEl     = document.getElementById("roleInfo");
    const listDescEl     = document.getElementById("listDesc");
    const scopeTextEl    = document.getElementById("scopeText");

    const btnCheckShop  = document.getElementById("btnCheckShop");
    const searchBeforeAddEl = document.getElementById("searchBeforeAdd");
    const btnAddNew     = document.getElementById("btnAddNew");
    const btnGoMap      = document.getElementById("btnGoMap");
    const btnSelectAll  = document.getElementById("btnSelectAll");
    const btnClearAll   = document.getElementById("btnClearAll");
    const tableSearchEl = document.getElementById("tableSearch");

    /* tabs */
    document.getElementById("tab-dashboard").onclick = ()=> location.href="./dashboard.html";
    document.getElementById("tab-map").onclick       = ()=> location.href="./map.html";
    document.getElementById("tab-analysis").onclick  = ()=> location.href="./shop-analysis.html";
    document.getElementById("tab-crm").onclick       = ()=> location.href="./customer-relations.html";

    /* ===== MASTER (‡∏†‡∏≤‡∏Ñ/‡∏•‡∏≤‡∏ô) ===== */
    const YARDS_MASTER = [
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß‡∏ö‡∏≤‡∏á‡∏ö‡∏≤‡∏•", lat:14.33616, lng:100.47968 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå 2", lat:15.63689, lng:100.12873 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", lat:16.17864, lng:99.73326 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏ö‡∏≤‡∏•", lat:14.32986, lng:100.47799 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢", lat:14.18774, lng:100.6339 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏™‡∏µ‡∏°‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", lat:15.93761, lng:99.94671 },

      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏û‡∏π‡∏ô", lat:18.64271, lng:99.05027 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", name:"‡∏•‡∏≤‡∏ô‡∏ò‡∏ô‡∏†‡∏±‡∏Å‡∏î‡∏µ", lat:19.04388, lng:98.96674 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", name:"‡∏•‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•‡∏™‡∏°‡∏±‡∏¢", lat:17.64006, lng:100.2385 },

      { region:"‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", lat:7.99312, lng:98.36943 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ", name:"‡∏•‡∏≤‡∏ô‡∏ô‡∏ó‡∏µ‡∏ä‡∏±‡∏¢", lat:9.08716, lng:99.17357 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏ß‡∏±‡∏á‡∏Ç‡∏ô‡∏≤‡∏¢", lat:13.95321, lng:99.65422 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", lat:13.8122, lng:100.07596 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡πÇ‡∏™‡∏°", lat:13.80447, lng:100.2476 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏™‡∏¥‡∏á‡∏Ç‡∏£", lat:14.08503, lng:99.49957 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏¢‡∏π‡πÑ‡∏ô‡πÄ‡∏ï‡πá‡∏î‡∏Ø", lat:13.79662, lng:100.18958 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏™‡∏∏‡∏£‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á", lat:13.65303, lng:100.28847 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ä‡∏±‡∏¢‡∏Ñ‡πâ‡∏≤‡∏™‡∏∏‡∏£‡∏≤", lat:13.59308, lng:99.80441 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ", lat:13.59385, lng:100.80435 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏¢‡∏µ‡πà‡∏Ç‡∏±‡∏ô", lat:13.95288, lng:100.49976 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏∂‡∏á", lat:13.60917, lng:100.79854 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û", lat:13.69784, lng:100.48059 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏•‡∏≤‡∏ô‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏π‡∏≠‡∏ô‡∏±‡∏ô‡∏ï‡πå", lat:13.96075, lng:101.56947 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", lat:16.34200, lng:102.83575 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô", name:"‡∏•‡∏≤‡∏ô‡πÄ‡∏ó‡∏û‡∏≠‡∏£‡∏∏‡πÇ‡∏ì‡∏ó‡∏±‡∏¢", lat:17.92127, lng:102.80889 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô", name:"‡∏•‡∏≤‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç", lat:16.73728, lng:102.8184 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä", lat:15.08781, lng:102.20054 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä", lat:15.08781, lng:102.20054 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏Ø", lat:15.19291, lng:104.82494 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏•‡∏≤‡∏ô‡πÄ‡∏≠‡∏™.‡πÄ‡∏≠‡∏™. ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏£‡∏≤", lat:15.23868, lng:105.15134 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏•‡∏≤‡∏ô‡∏≠‡∏ò‡∏¥‡∏°‡∏≤‡∏ï‡∏£", lat:15.30207, lng:103.24892 }
    ];

    /* ===== STATE ===== */
    let userProfile = null;
    let allShops    = [];
    let filteredShops = [];
    let currentRegion = "";
    let currentYard   = "";
    let softDeletedIds = [];

    function setStatus(msg, color="#b00020"){
      statusLineEl.textContent = msg||"";
      statusLineEl.style.color = color;
    }
    function loadSoftDeleted(){
      const raw = localStorage.getItem("tbr_soft_deleted");
      if(!raw) return [];
      try { return JSON.parse(raw) || []; } catch { return []; }
    }
    function saveSoftDeleted(arr){
      localStorage.setItem("tbr_soft_deleted", JSON.stringify(arr));
    }

    /* --- ROLE HELPERS --- */
    function shopVisibleForUser(shop, profile) {
      if (!profile || !profile.role) return !softDeletedIds.includes(shop.id);
      const role = profile.role;
      if (softDeletedIds.includes(shop.id)) return false;
      if (role === "admin" || role === "national") return true;
      if (role === "regional") {
        if (!profile.regionId) return false;
        return (shop.regionId === profile.regionId);
      }
      if (role === "yard") {
        if (profile.yardId) {
          return (shop.yardId === profile.yardId);
        }
        if (profile.regionId) {
          return (shop.regionId === profile.regionId);
        }
        return false;
      }
      return true;
    }

    function lockFiltersByRole(profile) {
      if (!profile) return;
      const role = profile.role;
      if (!role) return;

      if (role === "regional") {
        currentRegion = profile.regionId || "";
        regionFilterEl.value = currentRegion;
        regionFilterEl.disabled = true;
        buildYardDropdown(currentRegion);
        yardFilterEl.disabled = false;
        currentYard = "";
      } else if (role === "yard") {
        currentRegion = profile.regionId || "";
        currentYard   = profile.yardId || "";
        regionFilterEl.value = currentRegion;
        regionFilterEl.disabled = true;
        buildYardDropdown(currentRegion);
        yardFilterEl.value = currentYard;
        yardFilterEl.disabled = true;
      } else {
        // admin / national
        regionFilterEl.disabled = false;
        yardFilterEl.disabled   = false;
      }

      if (scopeTextEl) {
        scopeTextEl.textContent = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á: " + (
          profile.yardId || profile.regionId || "‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
        );
      }
      if (roleInfoEl) {
        roleInfoEl.textContent = "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: " + role;
      }
    }

    async function loadUserProfile(uid){
      const local = sessionStorage.getItem("userProfile");
      if (local) {
        try {
          return JSON.parse(local);
        } catch(e){}
      }
      return { uid, role:"admin" };
    }

    async function loadShopsFromFirestore(){
      try{
        const colRef = collection(db,"shops");
        const snap = await getDocs(colRef);
        const arr = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          arr.push({
            id: docSnap.id,
            shopName: d.shopName || d.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)",
            location: d.location || {},
            regionId: d.regionId || "",
            yardId: d.yardId || "",
            materialFlow: d.materialFlow || {}
          });
        });
        return arr;
      }catch(e){
        setStatus("‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå) ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏ó‡∏ô","#c62828");
        return [
          {
            id:"offline-1",
            shopName:"‡∏™‡∏≤‡∏¢‡∏ä‡∏°‡∏û‡∏π ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•",
            location:{
              address:"29 ‡∏´‡∏°‡∏π‡πà 3 ‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏≠‡∏Å ‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô",
              province:"‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ",
              gps_lat:15.49383,
              gps_lng:104.47948
            },
            regionId:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á",
            yardId:"‡∏•‡∏≤‡∏ô‡πÄ‡∏≠‡∏™.‡πÄ‡∏≠‡∏™. ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏£‡∏≤"
          }
        ];
      }
    }

    function buildRegionDropdown(){
      const regions = [...new Set(YARDS_MASTER.map(y=>y.region))];
      regionFilterEl.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + regions.map(r=>`<option value="${r}">${r}</option>`).join("");
    }
    function buildYardDropdown(region=""){
      const yards = region
        ? YARDS_MASTER.filter(y=>y.region===region)
        : YARDS_MASTER;
      yardFilterEl.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + yards.map(y=>`<option value="${y.name}">${y.region} - ${y.name}</option>`).join("");
    }

    function applyFilter(){
      filteredShops = allShops.filter(s => {
        if (!shopVisibleForUser(s, userProfile)) return false;
        if (currentRegion) {
          if (s.regionId !== currentRegion && s.region !== currentRegion) return false;
        }
        if (currentYard) {
          if (s.yardId !== currentYard && s.yard !== currentYard) return false;
        }
        return true;
      });
      renderShops();
    }

    function renderShops(){
  shopsBodyEl.innerHTML = "";

  if(!filteredShops.length){
    shopsBodyEl.innerHTML = `<tr><td colspan="6" style="padding:14px;color:#888">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</td></tr>`;
    listDescEl.textContent = "0 ‡∏£‡πâ‡∏≤‡∏ô";
    return;
  }

  filteredShops.forEach((s)=>{
    const loc = s.location || {};
    const lat = loc.gps_lat ?? s.lat ?? "";
    const lng = loc.gps_lng ?? s.lng ?? "";

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ/‡∏•‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ
    const regionName = s.regionId || s.region || "-";
    const yardName   = s.yardId   || s.yard   || "";

    const tr = document.createElement("tr");
    tr.id = "row-"+s.id;
    tr.innerHTML = `
      <td><input type="checkbox" class="row-check" data-id="${s.id}"></td>
      <td>${s.shopName || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)"}</td>
      <td>${(loc.address || "")} ${(loc.province || "")}</td>
      <td>
        <span class="tag">${regionName}</span>
        ${yardName ? `<span class="tag">${yardName}</span>` : ""}
      </td>
      <td>${lat && lng ? `${lat}, ${lng}` : "-"}</td>
      <td>
        <div class="row-actions">
          <button class="btn-sm btn-view" data-id="${s.id}">‡∏î‡∏π</button>
          <button class="btn-sm btn-edit" data-id="${s.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn-sm btn-del" data-id="${s.id}">‡∏•‡∏ö</button>
        </div>
      </td>
    `;
    shopsBodyEl.appendChild(tr);
  });

  listDescEl.textContent = `${filteredShops.length} ‡∏£‡πâ‡∏≤‡∏ô`;
}

    function getShopById(id){
      return allShops.find(s=>s.id===id);
    }
    function focusRow(id){
      const row = document.getElementById("row-"+id);
      if(!row) return;
      row.scrollIntoView({behavior:"smooth",block:"center"});
      row.classList.add("row-highlight");
      setTimeout(()=>row.classList.remove("row-highlight"),2000);
    }

    /* ===== ROW ACTIONS ===== */
    shopsBodyEl.addEventListener("click", async (ev)=>{
      const btn = ev.target;
      const id  = btn.dataset.id;
      if(!id) return;

      if(btn.classList.contains("btn-view")){
        const shop = getShopById(id);
        if(!shop) return;
        sessionStorage.setItem("currentShop", JSON.stringify(shop));
        location.href = "./shop-detail.html";
      }

      if(btn.classList.contains("btn-edit")){
        const shop = getShopById(id);
        if(!shop) return;
        // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ add-shop ‡πÉ‡∏ä‡πâ
        sessionStorage.setItem("editShop", JSON.stringify(shop));
        location.href = "./add-shop.html";
      }

      if(btn.classList.contains("btn-del")){
        if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")) return;

        // 1) ‡∏•‡∏ö‡πÉ‡∏ô Firestore (‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
        let deletedOnServer = false;
        try{
          await deleteDoc(doc(db,"shops",id));
          deletedOnServer = true;
        }catch(e){
          // ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ö‡∏•‡πá‡∏≠‡∏Å / ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
          console.warn("‡∏•‡∏ö‡∏ö‡∏ô Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô soft-delete ‡πÅ‡∏ó‡∏ô", e);
        }

        // 2) ‡πÄ‡∏Å‡πá‡∏ö soft-delete ‡πÑ‡∏ß‡πâ
        if(!softDeletedIds.includes(id)){
          softDeletedIds.push(id);
          saveSoftDeleted(softDeletedIds);
        }

        // 3) ‡∏•‡∏ö‡∏à‡∏≤‡∏Å array ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        allShops = allShops.filter(s=>s.id!==id);
        applyFilter();

        if(deletedOnServer){
          setStatus("‡∏•‡∏ö‡∏ö‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ","#2f7d32");
        }else{
          setStatus("‡∏•‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏ß‡πâ) ‚úÖ","#2f7d32");
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢
        sessionStorage.setItem("allShops", JSON.stringify(allShops));
      }
    });

    /* ===== SELECT ALL / CLEAR ===== */
    btnSelectAll.addEventListener("click", ()=>{
      document.querySelectorAll(".row-check").forEach(ch=> ch.checked = true);
    });
    btnClearAll.addEventListener("click", ()=>{
      document.querySelectorAll(".row-check").forEach(ch=> ch.checked = false);
    });

    /* ===== CHECK BEFORE ADD ===== */
    btnCheckShop.addEventListener("click", ()=>{
      const kw = (searchBeforeAddEl.value||"").trim();
      if(!kw){
        checkResultEl.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô";
        return;
      }
      const found = allShops.filter(s=>(s.shopName||"").includes(kw));
      if(!found.length){
        checkResultEl.style.color="#2f7d32";
        checkResultEl.innerHTML="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚úÖ";
      }else{
        checkResultEl.style.color="#b00020";
        checkResultEl.innerHTML = "‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô "+found.length+" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:<br>" +
          found.map(f=>`<div>
            ‚Ä¢ ${f.shopName}
            <button data-goto="${f.id}" class="btn-secondary" style="margin-left:4px;margin-top:4px">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            <button data-view="${f.id}" class="btn-secondary" style="margin-left:4px;margin-top:4px">‡∏î‡∏π‡πÄ‡∏•‡∏¢</button>
          </div>`).join("");
      }
    });
    checkResultEl.addEventListener("click",(ev)=>{
      const go = ev.target.dataset.goto;
      const view = ev.target.dataset.view;
      if(go){ focusRow(go); }
      if(view){
        const shop = getShopById(view);
        if(!shop) return;
        sessionStorage.setItem("currentShop", JSON.stringify(shop));
        location.href = "./shop-detail.html";
      }
    });

    /* ===== ADD NEW ===== */
    btnAddNew.addEventListener("click", ()=>{
      sessionStorage.removeItem("editShop");
      location.href="./add-shop.html";
    });

    /* ===== SEND TO MAP ===== */
    btnGoMap.addEventListener("click", ()=>{
      const picks = [];
      document.querySelectorAll(".row-check:checked").forEach(ch=>{
        const id = ch.dataset.id;
        const shop = getShopById(id);
        if(shop){
          const loc = shop.location || {};
          picks.push({
            id: shop.id,
            shopName: shop.shopName,
            location: {
              address: loc.address || "",
              province: loc.province || "",
              gps_lat: loc.gps_lat ?? shop.lat ?? null,
              gps_lng: loc.gps_lng ?? shop.lng ?? null
            },
            regionId: shop.regionId || "",
            yardId: shop.yardId || ""
          });
        }
      });
      if(!picks.length){
        setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà","#b00020");
        return;
      }
      sessionStorage.setItem("selectedShopsForMap", JSON.stringify(picks));
      location.href="./map.html";
    });

    /* ===== FILTER CHANGE ===== */
    regionFilterEl.addEventListener("change", ()=>{
      currentRegion = regionFilterEl.value;
      buildYardDropdown(currentRegion);
      currentYard = "";
      applyFilter();
    });
    yardFilterEl.addEventListener("change", ()=>{
      currentYard = yardFilterEl.value;
      applyFilter();
    });

    /* ===== TABLE SEARCH ===== */
    tableSearchEl.addEventListener("input", ()=>{
      const q = tableSearchEl.value.toLowerCase().trim();
      const rows = shopsBodyEl.querySelectorAll("tr");
      rows.forEach(row=>{
        const txt = row.textContent.toLowerCase();
        row.style.display = txt.includes(q) ? "" : "none";
      });
    });

    /* ===== LOGOUT ===== */
    btnLogoutEl.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(e){}
      sessionStorage.clear();
      location.href="./login.html";
    });

    /* ===== INIT ===== */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "./login.html";
        return;
      }

      userEmailEl.textContent = user.email || "-";

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡πà‡∏≠‡∏ô
      softDeletedIds = loadSoftDeleted();

      userProfile = await loadUserProfile(user.uid);

      // build dropdown
      buildRegionDropdown();
      buildYardDropdown("");

      // ‡∏•‡πá‡∏≠‡∏Å‡∏ï‡∏≤‡∏° role
      lockFiltersByRole(userProfile);

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô
      const shops = await loadShopsFromFirestore();
      allShops = shops
        .filter(s => !softDeletedIds.includes(s.id))
        .map(s => {
          const loc = s.location || {};
          return {
            id: s.id,
            shopName: s.shopName || s.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)",
            location: loc,
            regionId: s.regionId || s.region || "",
            yardId:   s.yardId   || s.yard   || ""
          };
        });

      // ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
      sessionStorage.setItem("allShops", JSON.stringify(allShops));

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      applyFilter();
    });
  </script>
</body>
</html>
