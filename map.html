<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TBR Recycling OPS | ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà & ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>

  <style>
    :root{
      --bg-main:#e8f3e8;
      --bg-card:#fff;
      --bg-soft:#f5faf5;
      --text:#1a1a1a;
      --green:#2f7d32;
      --bd:1px solid rgba(0,0,0,.07);
      --shadow:0 16px 40px rgba(0,0,0,.06);
      --shadow-sm:0 8px 20px rgba(0,0,0,.07);
    }
    *{box-sizing:border-box;font-family:"Kanit",system-ui,sans-serif}
    body{min-height:100vh;background:var(--bg-main);margin:0;display:flex;flex-direction:column}

    /* ===== HEADER / TABS ===== */
    .topbar-wrap{
      position:sticky;
      top:0;
      z-index:999;
      background:#fff;
      box-shadow:0 4px 16px rgba(0,0,0,.05);
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
      padding:14px 20px 10px;
    }
    .topbar-left{display:flex;gap:12px;align-items:center}
    .logo-box{
      width:52px;height:52px;border-radius:14px;
      background:#d9ead9;border:1px solid rgba(0,0,0,.04);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
    }
    .logo-box img{width:100%;height:100%;object-fit:contain}
    .app-title{display:flex;flex-direction:column}
    .app-name{font-size:18px;font-weight:600;color:var(--green)}
    .app-sub{font-size:13px;color:#555}
    .topbar-right{display:flex;gap:10px;align-items:center}
    .user-mail{font-size:13px;color:#444}
    .btn-logout{
      background:#fff;border:1px solid rgba(0,0,0,.14);
      border-radius:12px;padding:6px 14px;font-weight:600;cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
    }
    .tabs{
      display:flex;
      background:linear-gradient(180deg,#fff 0%,#f4f8f4 100%);
      border-top:1px solid rgba(0,0,0,.03);
    }
    .tab{
      padding:10px 22px;
      cursor:pointer;
      font-weight:600;
      color:#2d3b2f;
      border-bottom:3px solid transparent;
    }
    .tab:hover{background:rgba(232,243,232,.35);}
    .tab.active{
      color:var(--green);
      border-bottom:3px solid var(--green);
      background:#e8f6ea;
    }

    main{flex:1;display:flex;min-height:0;}
    aside{
      width:360px;
      background:#fff;
      border-right:var(--bd);
      box-shadow:8px 0 30px rgba(0,0,0,.05);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
      overflow:auto;
    }
    .card{
      background:var(--bg-soft);border:var(--bd);border-radius:12px;box-shadow:var(--shadow-sm);
      padding:16px;display:flex;flex-direction:column;gap:12px;
    }
    .head{font-weight:600;color:var(--green);display:flex;gap:6px;align-items:center}
    .desc{font-size:13px;color:#777}
    label{font-size:13px;font-weight:600;margin-bottom:4px}
    input,select{padding:8px 10px;border:1px solid rgba(0,0,0,.2);border-radius:8px}
    input:focus,select:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(47,125,50,.18)}
    .submit{background:var(--green);color:#fff;border:none;border-radius:8px;padding:10px 12px;font-weight:600;box-shadow:0 10px 20px rgba(47,125,50,.3);cursor:pointer}
    .status{min-height:20px;font-size:13px;font-weight:600;color:#b00020;white-space:pre-line}
    .shop{display:flex;flex-direction:column;gap:8px}
    .shop-item{background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:8px;padding:10px 12px;box-shadow:var(--shadow-sm);font-size:13px}
    .shop-item .name{font-weight:600}
    .mapwrap{flex:1;position:relative;display:flex;flex-direction:column}
    #map{flex:1;min-height:400px;border-top:var(--bd);border-left:var(--bd);box-shadow:inset 0 0 30px rgba(0,0,0,.05);background:#f0f0f0}
    .hint{position:absolute;top:16px;right:16px;background:#fff;border:var(--bd);border-radius:12px;box-shadow:var(--shadow);padding:12px 16px;max-width:280px;font-size:13px;z-index:500}
    .hint .title{font-weight:600;color:var(--green)}
    .dist{font-weight:600;margin-top:6px}
    .search-list-item{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:6px;padding:5px 6px;display:flex;justify-content:space-between;align-items:center;gap:6px}
    .btn-add-sm{background:#e8f6ea;border:none;border-radius:999px;font-size:12px;padding:3px 10px;cursor:pointer;color:#2f7d32;font-weight:600}
    @media(max-width:960px){
      main{flex-direction:column}
      aside{width:100%;max-height:360px;flex:0 0 auto;display:block}
      .mapwrap{min-height:400px}
    }
  </style>
</head>
<body>
  <!-- ===== TOPBAR STICKY ===== -->
  <div class="topbar-wrap">
    <div class="topbar">
      <div class="topbar-left">
        <div class="logo-box"><img src="logo.png" alt="TBR Logo"></div>
        <div class="app-title">
          <div class="app-name">TBR Recycling OPS</div>
          <div class="app-sub">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà &amp; ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‚Äî ‡∏†‡∏≤‡∏Ñ/‡∏•‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="user-mail" id="userEmail">-</div>
        <button class="btn-logout" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tab" id="tab-list">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•</div>
      <div class="tab active" id="tab-map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà &amp; ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
      <div class="tab" id="tab-analysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <div class="tab" id="tab-crm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
    </div>
  </div>

  <main>
    <aside>
      <div class="card">
        <div class="head">üè≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≤‡∏ô/‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
        <div class="desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞</div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô (‡∏†‡∏≤‡∏Ñ / ‡∏•‡∏≤‡∏ô)</label>
        <select id="yardSelect">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô --</option>
        </select>
        <label>Lat ‡∏•‡∏≤‡∏ô (‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î)</label>
        <input id="baseLat" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15.123456"/>
        <label>Lng ‡∏•‡∏≤‡∏ô (‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î)</label>
        <input id="baseLng" placeholder="‡πÄ‡∏ä‡πà‡∏ô 104.654321"/>
        <button class="submit" id="btnRecalc">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</button>
        <div class="status" id="statusLine"></div>
      </div>

      <div class="card">
        <div class="head">üì• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Dashboard</div>
        <div class="desc">‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ‡πÉ‡∏ô sessionStorage</div>
        <input id="shopSearch" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô..."/>
        <div id="shopSearchResult" class="shop" style="max-height:160px;overflow:auto"></div>
      </div>

      <div class="card">
        <div class="head">üóÇ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        <div class="desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞ (‡πÉ‡∏Å‡∏•‡πâ ‚Üí ‡πÑ‡∏Å‡∏•) ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô</div>
        <div class="shop" id="shopList"></div>
        <button class="submit" id="btnRoutePreview">‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô (‡∏ê‡∏≤‡∏ô ‚ûú ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î)</button>
        <div class="desc" style="font-size:12px">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢ ORS</div>
      </div>
    </aside>

    <section class="mapwrap">
      <div class="hint">
        <div class="title">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</div>
        <small>‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°: ‡∏ß‡∏¥‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ (‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á)<br/>‡∏™‡πâ‡∏°: ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á</small>
        <div class="dist" id="totalDistText">‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: - ‡∏Å‡∏°.</div>
        <div class="dist" id="weighWarnText" style="font-size:12px;font-weight:400;color:#b00020;margin-top:8px"></div>
      </div>
      <div id="map"></div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    /* ============ 1) MASTER ‡∏•‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏Ñ‡πâ‡∏î ============ */
    const YARDS_MASTER = [
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß‡∏ö‡∏≤‡∏á‡∏ö‡∏≤‡∏•", address:"‡∏ï.‡∏û‡∏£‡∏∞‡∏Ç‡∏≤‡∏ß ‡∏≠.‡∏ö‡∏≤‡∏á‡∏ö‡∏≤‡∏• ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", lat:14.33616, lng:100.47968 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå 2", address:"‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", lat:15.63689, lng:100.12873 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", address:"‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", lat:16.17864, lng:99.73326 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏ö‡∏≤‡∏•", address:"‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", lat:14.32986, lng:100.47799 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢", address:"‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", lat:14.18774, lng:100.6339 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå", name:"‡∏•‡∏≤‡∏ô‡∏™‡∏µ‡∏°‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", address:"‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", lat:15.93761, lng:99.94671 },

      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏û‡∏π‡∏ô", address:"‡∏•‡∏≥‡∏û‡∏π‡∏ô", lat:18.64271, lng:99.05027 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", name:"‡∏•‡∏≤‡∏ô‡∏ò‡∏ô‡∏†‡∏±‡∏Å‡∏î‡∏µ", address:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", lat:19.04388, lng:98.96674 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠", name:"‡∏•‡∏≤‡∏ô‡∏°‡∏á‡∏Ñ‡∏•‡∏™‡∏°‡∏±‡∏¢", address:"‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", lat:17.64006, lng:100.2385 },

      { region:"‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", address:"‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", lat:7.99312, lng:98.36943 },
      { region:"‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ", name:"‡∏•‡∏≤‡∏ô‡∏ô‡∏ó‡∏µ‡∏ä‡∏±‡∏¢", address:"‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", lat:9.08716, lng:99.17357 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏ß‡∏±‡∏á‡∏Ç‡∏ô‡∏≤‡∏¢", address:"‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", lat:13.95321, lng:99.65422 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", address:"‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", lat:13.8122, lng:100.07596 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡πÇ‡∏™‡∏°", address:"‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", lat:13.80447, lng:100.2476 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏™‡∏¥‡∏á‡∏Ç‡∏£", address:"‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", lat:14.08503, lng:99.49957 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏¢‡∏π‡πÑ‡∏ô‡πÄ‡∏ï‡πá‡∏î‡∏Ø", address:"‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", lat:13.79662, lng:100.18958 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏™‡∏∏‡∏£‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á", address:"‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", lat:13.65303, lng:100.28847 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ä‡∏±‡∏¢‡∏Ñ‡πâ‡∏≤‡∏™‡∏∏‡∏£‡∏≤", address:"‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", lat:13.59308, lng:99.80441 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ", address:"‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", lat:13.59385, lng:100.80435 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏•‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏¢‡∏µ‡πà‡∏Ç‡∏±‡∏ô", address:"‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", lat:13.95288, lng:100.49976 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏∂‡∏á", address:"‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", lat:13.60917, lng:100.79854 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û", address:"‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø", lat:13.69784, lng:100.48059 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å", name:"‡∏•‡∏≤‡∏ô‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏π‡∏≠‡∏ô‡∏±‡∏ô‡∏ï‡πå", address:"‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", lat:13.96075, lng:101.56947 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", address:"‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", lat:16.34200, lng:102.83575 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô", name:"‡∏•‡∏≤‡∏ô‡πÄ‡∏ó‡∏û‡∏≠‡∏£‡∏∏‡πÇ‡∏ì‡∏ó‡∏±‡∏¢", address:"‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", lat:17.92127, lng:102.80889 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô", name:"‡∏•‡∏≤‡∏ô‡πÅ‡∏Å‡πà‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç", address:"‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", lat:16.73728, lng:102.8184 },

      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä", address:"‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", lat:15.08781, lng:102.20054 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä", address:"‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", lat:15.08781, lng:102.20054 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏Ø", address:"‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", lat:15.19291, lng:104.82494 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏•‡∏≤‡∏ô‡πÄ‡∏≠‡∏™.‡πÄ‡∏≠‡∏™. ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏£‡∏≤", address:"‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", lat:15.23868, lng:105.15134 },
      { region:"‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", name:"‡∏•‡∏≤‡∏ô‡∏≠‡∏ò‡∏¥‡∏°‡∏≤‡∏ï‡∏£", address:"‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", lat:15.30207, lng:103.24892 }
    ];

    const WEIGHMASTER = [
      { name:"‡∏î‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á", note:"‡∏°‡∏±‡∏Å‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏±‡πà‡∏á‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á", lat:15.20000, lng:104.85000 },
      { name:"‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏á‡∏ñ‡∏≤‡∏ß‡∏£", note:"‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", lat:15.10000, lng:102.20000 }
    ];

    /* ============ 2) FIREBASE ============ */
    const firebaseConfig = {
      apiKey:"AIzaSyCDUGrwNqCOe_lysRbABlp3r6woaL_L1L4",
      authDomain:"tbr-recycling-ops.firebaseapp.com",
      projectId:"tbr-recycling-ops",
      storageBucket:"tbr-recycling-ops.firebasestorage.app",
      messagingSenderId:"527372313469",
      appId:"1:527372313469:web:d7260893ba8deee81fe214"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ============ 3) DOM ============ */
    const yardSelectEl = document.getElementById("yardSelect");
    const baseLatEl = document.getElementById("baseLat");
    const baseLngEl = document.getElementById("baseLng");
    const btnRecalc = document.getElementById("btnRecalc");
    const statusLineEl = document.getElementById("statusLine");
    const shopListEl = document.getElementById("shopList");
    const totalDistEl = document.getElementById("totalDistText");
    const weighWarnEl = document.getElementById("weighWarnText");
    const btnRoutePreview = document.getElementById("btnRoutePreview");
    const shopSearchEl = document.getElementById("shopSearch");
    const shopSearchResultEl = document.getElementById("shopSearchResult");
    const userEmailEl = document.getElementById("userEmail");

    /* ============ 4) STATE ============ */
    let map, baseMarker=null, shopMarkers=[], linkLines=[], routeLine=null, liveRouteLayer=null, weighMarkers=[];
    let shopsChosen=[], basePoint={lat:null,lng:null}, userProfile=null;
    let allShopsFromDashboard = [];

    /* ===== icon ===== */
    const yardIcon = L.icon({
      iconUrl:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='none'><path d='M12 2L3 9h3v10h12V9h3L12 2z' stroke='#1b5e20' stroke-width='2' fill='#a5d6a7'/><circle cx='12' cy='13' r='2.5' fill='#1b5e20'/></svg>`),
      iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-28]
    });
    const shopIcon = L.icon({
      iconUrl:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='none'><path d='M4 10l2-5h12l2 5v8H4v-8z' fill='#1565c0' stroke='#0d47a1' stroke-width='1.5'/><path d='M9 14h6v4H9z' fill='#fff'/></svg>`),
      iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-28]
    });
    const weighIcon = L.icon({
      iconUrl:"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='none'><rect x='3' y='3' width='18' height='18' rx='4' fill='#fff3e0' stroke='#e65100' stroke-width='2'/><path d='M12 7v4m0 0l-4 5h8l-4-5z' stroke='#e65100' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><circle cx='12' cy='6' r='1' fill='#e65100'/></svg>`),
      iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-28]
    });

    /* ============ helpers ============ */
    function setStatus(msg,color="#b00020"){statusLineEl.textContent=msg||"";statusLineEl.style.color=color}
    const toRad = d=>d*Math.PI/180;
    function haversineKm(aLat,aLng,bLat,bLng){
      if([aLat,aLng,bLat,bLng].some(v=>v==null))return null;
      const R=6371;const dLat=toRad(bLat-aLat),dLng=toRad(bLng-aLng);
      const A=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    }
    function normalizeRegionName(s){
      if(!s) return "";
      const x = String(s).toLowerCase();
      if(x.includes("‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå")) return "‡∏†‡∏≤‡∏Ñ‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå";
      if(x.includes("‡πÄ‡∏´‡∏ô‡∏∑‡∏≠")) return "‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠";
      if(x.includes("‡πÉ‡∏ï‡πâ")) return "‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ";
      if(x.includes("‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å")) return "‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å";
      if(x.includes("‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å")) return "‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å";
      if(x.includes("‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô")) return "‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏ö‡∏ô";
      if(x.includes("‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á")) return "‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á";
      return s;
    }

    /* ============ ‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ============ */
    function getYardsForUser(profile){
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏•‡∏¢ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏•‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏™‡πÑ‡∏î‡πâ
      if(!profile || !profile.role){
        return YARDS_MASTER;
      }

      const role = String(profile.role).toLowerCase();

      if(role === "admin" || role === "national"){
        return YARDS_MASTER;
      }

      if(role === "regional"){
        const userRegion = normalizeRegionName(profile.regionId || profile.region || "");
        return YARDS_MASTER.filter(y=>{
          const yardRegion = normalizeRegionName(y.region);
          return yardRegion && userRegion && yardRegion === userRegion;
        });
      }

      if(role === "yard"){
        if(profile.yardId){
          // ‡∏ñ‡πâ‡∏≤ master ‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ
          const found = YARDS_MASTER.filter(y=>(y.yardId && y.yardId===profile.yardId) || y.name===profile.yardId);
          if(found.length) return found;
        }
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ yardId ‡∏Å‡πá‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏Ñ
        if(profile.regionId){
          const userRegion = normalizeRegionName(profile.regionId);
          return YARDS_MASTER.filter(y=> normalizeRegionName(y.region) === userRegion);
        }
      }

      return YARDS_MASTER;
    }

    /* ============ map init ============ */
    function initMap(){
      const el = document.getElementById("map");
      if(typeof L === "undefined"){
        el.innerHTML = "<div style='padding:16px;background:#fff;border:1px solid rgba(0,0,0,.15);border-radius:12px;max-width:360px;margin:16px;color:#b00020'>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>";
        return;
      }
      map = L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:"&copy; OpenStreetMap"}).addTo(map);
      map.setView([15,100],6);
    }

    /* ============ render yard dropdown ============ */
    function populateYardSelectForProfile(profile){
      yardSelectEl.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô --</option>`;
      const allowed = getYardsForUser(profile);
      allowed.forEach((y,i)=>{
        const o = document.createElement("option");
        o.value = String(i);
        o.textContent = `${y.region} - ${y.name}`;
        yardSelectEl.appendChild(o);
      });
    }

    /* ============ load shops from session (dashboard) ============ */
    function loadAllShopsFromSession(){
      const raw = sessionStorage.getItem("allShops");
      if(!raw) return [];
      try{
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{return [];}
    }

    function shopVisibleForUser(shop, profile){
      if(!profile || !profile.role) return true;
      const role = String(profile.role).toLowerCase();
      if(role==="admin" || role==="national") return true;
      if(role==="regional"){
        return normalizeRegionName(shop.regionId) === normalizeRegionName(profile.regionId);
      }
      if(role==="yard"){
        if(profile.yardId && shop.yardId) return shop.yardId === profile.yardId;
        if(profile.regionId) return normalizeRegionName(shop.regionId) === normalizeRegionName(profile.regionId);
      }
      return true;
    }

    function renderSearchList(keyword=""){
      shopSearchResultEl.innerHTML = "";
      const kw = keyword.trim().toLowerCase();
      const list = allShopsFromDashboard.filter(s=>{
        const n = (s.shopName || s.name || "").toLowerCase();
        return !kw || n.includes(kw);
      }).slice(0,25);

      if(!list.length){
        shopSearchResultEl.innerHTML = "<div style='font-size:12px;color:#999'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î dashboard ‡∏Å‡πà‡∏≠‡∏ô</div>";
        return;
      }

      list.forEach(s=>{
        const div = document.createElement("div");
        div.className = "search-list-item";
        div.innerHTML = `
          <div style="flex:1;min-width:0">
            <div style="font-weight:600">${s.shopName || s.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)"}</div>
            <div style="font-size:11px;color:#777">${s.location?.province || s.province || ""}</div>
          </div>
          <button class="btn-add-sm" data-id="${s.id || s.docId || ""}">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        `;
        shopSearchResultEl.appendChild(div);
      });
    }

    shopSearchEl.addEventListener("input", ()=>{
      renderSearchList(shopSearchEl.value);
    });

    shopSearchResultEl.addEventListener("click",(ev)=>{
      const id = ev.target.dataset.id;
      if(!id) return;
      const found = allShopsFromDashboard.find(s => (s.id||s.docId) === id);
      if(!found) return;
      const loc = found.location || {};
      const lat = loc.gps_lat ?? found.lat ?? null;
      const lng = loc.gps_lng ?? found.lng ?? null;
      if(shopsChosen.some(s=>s.id===id)){
        setStatus("‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß","#2f7d32");
        return;
      }
      shopsChosen.push({
        id: id,
        name: found.shopName || found.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô)",
        lat, lng,
        address: loc.address || found.address || "",
        province: loc.province || found.province || ""
      });
      redrawAll();
      setStatus("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å dashboard ‡πÅ‡∏•‡πâ‡∏ß","#2f7d32");
    });

    /* ============ ‡πÉ‡∏™‡πà‡∏•‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ============ */
    function onChooseYard(){
      const i = yardSelectEl.value;
      if(!i) return;
      const allowed = getYardsForUser(userProfile || {});
      const y = allowed[+i];
      if(!y) return;
      baseLatEl.value = y.lat;
      baseLngEl.value = y.lng;
      basePoint.lat = y.lat;
      basePoint.lng = y.lng;
      setStatus(`‡πÉ‡∏ä‡πâ‡∏•‡∏≤‡∏ô: ${y.name} (${y.region}) ‚úÖ`,"#2f7d32");
      redrawAll();
      showAllWeighStationsNearBase(100);
    }

    function recalcFromInputs(){
      const lat = parseFloat(baseLatEl.value.trim());
      const lng = parseFloat(baseLngEl.value.trim());
      if(isNaN(lat) || isNaN(lng)){
        setStatus("‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ê‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","#b00020");
        return;
      }
      basePoint.lat = lat;
      basePoint.lng = lng;
      setStatus("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ","#2f7d32");
      redrawAll();
      showAllWeighStationsNearBase(100);
    }

    /* ============ ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ============ */
    function redrawAll(){
      if(!map) return;
      if(baseMarker){map.removeLayer(baseMarker);baseMarker=null}
      shopMarkers.forEach(m=>map.removeLayer(m)); shopMarkers=[];
      linkLines.forEach(l=>map.removeLayer(l)); linkLines=[];
      if(routeLine){map.removeLayer(routeLine);routeLine=null}

      const bounds=[]; shopListEl.innerHTML="";

      if(basePoint.lat!=null && basePoint.lng!=null){
        baseMarker = L.marker([basePoint.lat,basePoint.lng],{title:"‡∏ê‡∏≤‡∏ô / ‡∏•‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",icon:yardIcon}).addTo(map);
        bounds.push([basePoint.lat,basePoint.lng]);
      }

      const withDist = shopsChosen.map(s=>({
        ...s,
        distKm: (basePoint.lat!=null ? haversineKm(basePoint.lat,basePoint.lng,s.lat,s.lng):null)
      })).sort((a,b)=>(a.distKm??1e9)-(b.distKm??1e9));

      withDist.forEach((s,i)=>{
        const dStr = s.distKm==null ? "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö" : `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ~ ${s.distKm.toFixed(2)} ‡∏Å‡∏°.`;
        const div = document.createElement("div");
        div.className = "shop-item";
        div.innerHTML = `
          <div class="name">${i+1}. ${s.name}</div>
          <div>${s.province||""}</div>
          <div style="word-break:break-word">${s.address||""}</div>
          <div>Lat ${s.lat??"-"}, Lng ${s.lng??"-"}</div>
          <div style="color:#2f7d32;font-weight:600">${dStr}</div>
        `;
        shopListEl.appendChild(div);

        if(s.lat!=null && s.lng!=null){
          const mk = L.marker([s.lat,s.lng],{icon:shopIcon}).addTo(map);
          mk.bindPopup(`<b>${s.name}</b><br/>${s.address||""}<br/>${dStr}`);
          shopMarkers.push(mk);
          bounds.push([s.lat,s.lng]);

          if(basePoint.lat!=null){
            const line = L.polyline([[basePoint.lat,basePoint.lng],[s.lat,s.lng]],{color:"#1a237e",weight:2,opacity:.5,dashArray:"4,6"}).addTo(map);
            linkLines.push(line);
          }
        }
      });

      if(basePoint.lat!=null){
        const valid = shopsChosen.filter(s=>s.lat!=null && s.lng!=null);
        let cur = [basePoint.lat,basePoint.lng], pts=[cur], total=0;
        valid.forEach(s=>{
          pts.push([s.lat,s.lng]);
          total += haversineKm(cur[0],cur[1],s.lat,s.lng) || 0;
          cur=[s.lat,s.lng];
        });
        if(pts.length>1){
          routeLine = L.polyline(pts,{color:"#0d47a1",weight:4,opacity:.85}).addTo(map);
        }
        totalDistEl.textContent = pts.length>1 ? `‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á): ${total.toFixed(2)} ‡∏Å‡∏°.` : "‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: - ‡∏Å‡∏°.";
      }

      if(bounds.length){
        map.fitBounds(L.latLngBounds(bounds),{padding:[40,40]});
      }
    }

    /* ============ ‡∏î‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏á‡∏£‡∏≠‡∏ö‡∏ê‡∏≤‡∏ô ============ */
    function showAllWeighStationsNearBase(radiusKm=100){
      if(!map || basePoint.lat==null) return;
      if(weighMarkers.length){weighMarkers.forEach(m=>map.removeLayer(m));weighMarkers=[]}
      const lines=[];
      WEIGHMASTER.forEach(st=>{
        const d = haversineKm(basePoint.lat,basePoint.lng,st.lat,st.lng);
        if(d!=null && d<=radiusKm){
          const mk = L.marker([st.lat,st.lng],{icon:weighIcon}).addTo(map);
          mk.bindPopup(`<div><b>‚öñ ${st.name}</b><br/>‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô ~ ${d.toFixed(2)} ‡∏Å‡∏°.</div>`);
          weighMarkers.push(mk);
          lines.push(`‚öñ ${st.name} (${d.toFixed(1)} ‡∏Å‡∏°.)`);
        }
      });
      weighWarnEl.textContent = lines.length ? `‚öñ ‡∏î‡πà‡∏≤‡∏ô/‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ ${radiusKm} ‡∏Å‡∏°.:\n${lines.join("\n")}` : "";
    }

    /* ============ ORS route ============ */
    async function fetchAndDrawDrivingRoute(startLat,startLng,endLat,endLng){
      if(typeof L==="undefined"){setStatus("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "#b00020");return;}
      if(liveRouteLayer){map.removeLayer(liveRouteLayer);liveRouteLayer=null}

      const key = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImQ5OGFkNDU3NDc4ZTQxOWE4OGFjOTAzNmE4YzhjNzRiIiwiaCI6Im11cm11cjY0In0=";
      const url = `https://api.openrouteservice.org/v2/directions/driving-hgv?api_key=${encodeURIComponent(key)}&start=${startLng},${startLat}&end=${endLng},${endLat}`;
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error("ORS error "+res.status);
        const data = await res.json();
        const coords = data.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);
        liveRouteLayer = L.polyline(coords,{color:"#ff5722",weight:5,opacity:.9}).addTo(map);
        map.fitBounds(liveRouteLayer.getBounds(),{padding:[40,40]});
        const dist = data.features[0].properties.summary.distance;
        const dur  = data.features[0].properties.summary.duration;
        totalDistEl.textContent = `‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á ~ ${(dist/1000).toFixed(2)} ‡∏Å‡∏°. / ${(dur/60).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;

        // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏™‡πâ‡∏ô 10 ‡∏Å‡∏°.
        const hits = [];
        WEIGHMASTER.forEach(st=>{
          let best=Infinity;
          coords.forEach(pt=>{
            const d = haversineKm(st.lat,st.lng,pt[0],pt[1]);
            if(d!=null && d<best) best=d;
          });
          if(best<=10){
            hits.push({...st,minDistKm:best});
          }
        });
        if(hits.length){
          weighWarnEl.textContent = "‚öñ ‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:\n" + hits.map(h=>`- ${h.name} (${h.minDistKm.toFixed(1)} ‡∏Å‡∏°.)`).join("\n");
          hits.forEach(h=>{
            const mk = L.marker([h.lat,h.lng],{icon:weighIcon}).addTo(map);
            weighMarkers.push(mk);
          });
        }

        setStatus("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ","#2f7d32");
      }catch(e){
        setStatus("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ñ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+e.message,"#b00020");
      }
    }

    function onPreviewRouteClick(){
      if(basePoint.lat==null || shopsChosen.length===0){
        setStatus("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ê‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤","#b00020");
        return;
      }
      let best=null, bd=Infinity;
      shopsChosen.forEach(s=>{
        if(s.lat!=null){
          const d=haversineKm(basePoint.lat,basePoint.lng,s.lat,s.lng);
          if(d<bd){bd=d;best=s;}
        }
      });
      if(!best){
        setStatus("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î","#b00020");
        return;
      }
      fetchAndDrawDrivingRoute(basePoint.lat,basePoint.lng,best.lat,best.lng);
    }

    /* ============ auth ============ */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href="./login.html";
        return;
      }
      userEmailEl.textContent = user.email || "-";

      // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Firestore
      let profile = null;
      try{
        const snap = await getDoc(doc(db,"users",user.uid));
        if(snap.exists()){
          profile = snap.data();
        }else{
          // offline / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Üí ‡∏•‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å session
          const local = sessionStorage.getItem("userProfile");
          if(local) profile = JSON.parse(local);
        }
      }catch(e){
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å session
        const local = sessionStorage.getItem("userProfile");
        if(local) profile = JSON.parse(local);
      }

      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢ ‚Üí ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏•‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
      if(!profile){
        profile = { role:"admin" }; // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ó‡∏™
      }
      userProfile = profile;
      sessionStorage.setItem("userProfile",JSON.stringify(profile));

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      populateYardSelectForProfile(profile);

      // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏≤‡∏ô ‚Üí ‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
      if(profile.yardLat!=null && profile.yardLng!=null){
        basePoint.lat = profile.yardLat;
        basePoint.lng = profile.yardLng;
        baseLatEl.value = profile.yardLat;
        baseLngEl.value = profile.yardLng;
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å dashboard ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      allShopsFromDashboard = loadAllShopsFromSession().filter(s=>shopVisibleForUser(s,profile));
      renderSearchList("");

      // init map
      initMap();
      if(basePoint.lat!=null) map.setView([basePoint.lat,basePoint.lng],10);
      redrawAll();
      if(basePoint.lat!=null) showAllWeighStationsNearBase(100);
    });

    /* ============ events ============ */
    yardSelectEl.addEventListener("change", onChooseYard);
    btnRecalc.addEventListener("click", recalcFromInputs);
    btnRoutePreview.addEventListener("click", onPreviewRouteClick);

    document.getElementById("tab-list").onclick = ()=>location.href="./dashboard.html";
    document.getElementById("tab-map").onclick  = ()=>location.href="./map.html";
    document.getElementById("tab-analysis").onclick  = ()=>location.href="./shop-analysis.html";
    document.getElementById("tab-crm").onclick  = ()=>location.href="./customer-relations.html";

    document.getElementById("btnLogout").addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(e){}
      sessionStorage.clear();
      location.href="./login.html";
    });
  </script>
</body>
</html>


